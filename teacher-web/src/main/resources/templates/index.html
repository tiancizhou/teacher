<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f5f0e8">
    <title>AI书法批改助手</title>
    <style>
        @import url('https://fonts.googleapis.cn/css2?family=Noto+Serif+SC:wght@400;600;700;900&family=Noto+Sans+SC:wght@300;400;500;600;700&display=swap');

        :root {
            --charcoal: #2c2c2c;
            --ink: #1a1a2e;
            --cream: #f5f0e8;
            --cream-light: #faf7f2;
            --gold: #c4a055;
            --gold-light: #d4b876;
            --gold-dark: #a8883e;
            --cinnabar: #c23a2e;
            --cinnabar-light: #d94e42;
            --indigo: #3d4f7c;
            --indigo-light: #5a6e9e;
            --paper: #f2ece0;
            --paper-dark: #e8dfd0;
            --grey-text: #8a8578;
            --grey-light: #b5ae9f;
            --ink-blue: #2c3e6b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans SC', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: var(--cream);
            min-height: 100vh;
            color: var(--charcoal);
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background:
                radial-gradient(ellipse 600px 300px at 10% 20%, rgba(61,79,124,0.06) 0%, transparent 70%),
                radial-gradient(ellipse 500px 400px at 85% 15%, rgba(61,79,124,0.05) 0%, transparent 60%),
                radial-gradient(ellipse 700px 350px at 50% 80%, rgba(61,79,124,0.04) 0%, transparent 70%),
                url("data:image/svg+xml,%3Csvg width='100' height='100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence baseFrequency='0.65' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 0;
        }

        body::after {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 280px;
            background: linear-gradient(180deg, rgba(44,62,107,0.12) 0%, rgba(61,79,124,0.06) 40%, transparent 100%);
            pointer-events: none;
            z-index: 0;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; position: relative; z-index: 1; }

        /* ==================== Header ==================== */
        .header { text-align: center; margin-bottom: 32px; }
        .header h1 {
            font-family: 'Noto Serif SC', 'STSong', 'SimSun', serif;
            font-size: 3rem; font-weight: 900; color: var(--ink);
            letter-spacing: 8px; margin-bottom: 12px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            display: inline-block; position: relative;
        }
        .header h1::after {
            content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%);
            width: 120px; height: 3px;
            background: linear-gradient(90deg, transparent, var(--gold), var(--gold-dark), var(--gold), transparent);
            border-radius: 2px;
        }
        .header p { font-size: 1rem; color: var(--grey-text); margin-top: 16px; letter-spacing: 2px; font-weight: 300; }

        /* ==================== Mode Tabs ==================== */
        .mode-tabs {
            display: flex; justify-content: center; gap: 0; margin-bottom: 28px;
            background: var(--paper-dark); border-radius: 8px; padding: 4px;
            max-width: 400px; margin-left: auto; margin-right: auto;
        }
        .mode-tab {
            flex: 1; padding: 10px 16px; text-align: center; cursor: pointer;
            font-family: 'Noto Serif SC', serif; font-size: 0.95rem; font-weight: 600;
            color: var(--grey-text); border-radius: 6px; transition: all 0.3s;
            letter-spacing: 2px; border: none; background: transparent;
            -webkit-tap-highlight-color: transparent;
        }
        .mode-tab.active {
            background: var(--cream-light); color: var(--ink);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        /* ==================== Card Base ==================== */
        .card {
            background: var(--cream-light); border-radius: 12px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.06), 0 1px 3px rgba(0,0,0,0.04), inset 0 1px 0 rgba(255,255,255,0.8);
            padding: 36px; margin-bottom: 30px; border: 1px solid rgba(196,160,85,0.15); position: relative;
        }

        /* ==================== Template Selector ==================== */
        .template-section { margin-bottom: 20px; }
        .template-section .section-label {
            font-family: 'Noto Serif SC', serif; font-size: 0.92rem; font-weight: 600;
            color: var(--charcoal); margin-bottom: 12px; letter-spacing: 1px;
            display: flex; align-items: center; gap: 6px;
        }
        .template-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 10px;
        }
        .template-card {
            padding: 12px 10px; border: 2px solid rgba(196,160,85,0.15); border-radius: 8px;
            text-align: center; cursor: pointer; transition: all 0.25s;
            background: var(--cream-light);
            -webkit-tap-highlight-color: transparent;
        }
        .template-card:hover { border-color: var(--gold-light); background: #faf5eb; }
        .template-card.selected {
            border-color: var(--gold); background: linear-gradient(135deg, #faf5eb, #f5ece0);
            box-shadow: 0 0 0 3px rgba(196,160,85,0.15);
        }
        .template-card .tpl-name {
            font-family: 'Noto Serif SC', serif; font-size: 0.88rem; font-weight: 600;
            color: var(--charcoal); margin-bottom: 4px;
        }
        .template-card .tpl-desc {
            font-size: 0.72rem; color: var(--grey-text);
        }
        .template-card .tpl-icon {
            font-size: 1.4rem; margin-bottom: 4px; display: block;
        }
        .template-card.free-mode { border-style: dashed; }

        /* ==================== Upload Area ==================== */
        .upload-area {
            border: 2px dashed var(--grey-light); border-radius: 12px;
            padding: 60px 20px; text-align: center; cursor: pointer;
            transition: all 0.4s; position: relative;
            background: linear-gradient(135deg, var(--cream-light), var(--paper));
        }
        .upload-area:hover, .upload-area.dragover {
            border-color: var(--gold); background: linear-gradient(135deg, #faf5eb, #f5ece0);
            box-shadow: 0 0 0 4px rgba(196,160,85,0.08);
        }
        .upload-area .icon { font-size: 52px; margin-bottom: 16px; filter: grayscale(30%); }
        .upload-area h3 { font-family: 'Noto Serif SC', serif; font-size: 1.15rem; color: var(--charcoal); margin-bottom: 8px; font-weight: 600; }
        .upload-area p { color: var(--grey-text); font-size: 0.85rem; }
        .upload-area input[type="file"] { position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer; }

        /* Preview */
        .preview-section { display: none; margin-top: 24px; text-align: center; }
        .preview-section.visible { display: block; }
        .preview-img { max-width: 100%; max-height: 300px; border-radius: 4px; border: 3px solid var(--paper-dark); box-shadow: 0 4px 16px rgba(0,0,0,0.08); }
        .preview-info-bar { margin-top: 10px; font-size: 0.78rem; color: var(--grey-text); }
        .btn-reselect { display: inline-block; background: transparent; color: var(--grey-text); border: none; padding: 8px 16px; font-size: 0.85rem; cursor: pointer; margin-top: 8px; text-decoration: underline; font-family: 'Noto Sans SC', sans-serif; }
        .btn-reselect:hover { color: var(--charcoal); }

        /* ==================== Mobile Upload ==================== */
        .mobile-upload { text-align: center; }
        .mobile-upload-btns { display: flex; gap: 12px; }
        .mobile-upload-btn {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 28px 12px 24px; border: 2px solid rgba(196,160,85,0.2); border-radius: 12px;
            background: linear-gradient(135deg, var(--cream-light), var(--paper));
            cursor: pointer; transition: all 0.3s; position: relative; -webkit-tap-highlight-color: transparent;
        }
        .mobile-upload-btn:active { transform: scale(0.97); background: linear-gradient(135deg, #f5ece0, #ede4d4); }
        .mobile-upload-btn input[type="file"] { position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer; }
        .mobile-btn-icon { font-size: 36px; margin-bottom: 8px; }
        .mobile-btn-text { font-family: 'Noto Serif SC', serif; font-size: 1rem; font-weight: 600; color: var(--charcoal); letter-spacing: 1px; }
        .mobile-btn-hint { font-size: 0.72rem; color: var(--grey-light); margin-top: 4px; }
        .camera-btn { border-color: rgba(194,58,46,0.2); }

        /* ==================== Single Char: Crop from page ==================== */
        .crop-section { display: none; margin-top: 20px; text-align: center; }
        .crop-section.visible { display: block; }
        .crop-section .crop-hint {
            font-size: 0.85rem; color: var(--grey-text); margin-bottom: 12px;
        }
        .crop-canvas-wrap {
            position: relative; display: inline-block; cursor: crosshair;
            border: 2px solid var(--paper-dark); border-radius: 4px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }
        .crop-canvas-wrap canvas {
            display: block; max-width: 100%;
            touch-action: none; user-select: none; -webkit-user-select: none;
        }
        .crop-magnifier {
            position: absolute; right: 8px; top: 8px;
            width: 132px; height: 132px;
            border-radius: 50%; overflow: hidden;
            border: 3px solid rgba(194,58,46,0.9);
            background: #fff;
            box-shadow: 0 8px 18px rgba(0,0,0,0.25);
            pointer-events: none;
            display: none;
            z-index: 3;
        }
        .crop-magnifier.visible { display: block; }
        .crop-magnifier canvas { width: 100%; height: 100%; display: block; }
        .crop-actions { margin-top: 12px; display: flex; gap: 10px; justify-content: center; }

        /* ==================== Buttons ==================== */
        .btn-primary {
            display: inline-block; background: var(--cinnabar); color: #fff; border: none;
            padding: 14px 48px; font-size: 1.05rem; font-weight: 600; border-radius: 4px;
            cursor: pointer; transition: all 0.3s; margin-top: 24px;
            font-family: 'Noto Serif SC', serif; letter-spacing: 4px;
            box-shadow: 0 4px 16px rgba(194,58,46,0.25);
        }
        .btn-primary:hover { background: var(--cinnabar-light); transform: translateY(-1px); box-shadow: 0 6px 24px rgba(194,58,46,0.3); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .btn-secondary {
            display: inline-block; background: var(--indigo); color: #fff; border: none;
            padding: 10px 28px; font-size: 0.92rem; font-weight: 600; border-radius: 4px;
            cursor: pointer; transition: all 0.3s; font-family: 'Noto Serif SC', serif;
            letter-spacing: 2px; box-shadow: 0 2px 12px rgba(61,79,124,0.2);
        }
        .btn-secondary:hover { background: var(--indigo-light); }
        .btn-secondary:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-seal {
            display: inline-block; background: var(--cinnabar); color: #fff;
            border: 2px solid var(--cinnabar); padding: 12px 36px; font-size: 1rem;
            font-weight: 700; font-family: 'Noto Serif SC', serif; letter-spacing: 6px;
            cursor: pointer; transition: all 0.3s; border-radius: 2px;
            box-shadow: 0 4px 16px rgba(194,58,46,0.3), inset 0 0 0 2px rgba(255,255,255,0.15);
        }
        .btn-seal:hover { background: var(--cinnabar-light); transform: translateY(-2px) scale(1.02); }

        /* ==================== Loading ==================== */
        .loading { display: none; text-align: center; padding: 40px 20px; }
        .loading.visible { display: block; }
        .loading-card {
            background: var(--cream-light); border-radius: 16px;
            box-shadow: 0 8px 40px rgba(0,0,0,0.08); border: 1px solid rgba(196,160,85,0.15);
            padding: 48px 40px 40px; max-width: 640px; margin: 0 auto; position: relative; overflow: hidden;
        }
        .loading-card::before {
            content: ''; position: absolute; top: -60px; right: -60px; width: 200px; height: 200px;
            background: radial-gradient(circle, rgba(44,62,107,0.04) 0%, transparent 70%); pointer-events: none;
        }
        .ink-animation { width: 100px; height: 100px; margin: 0 auto 28px; position: relative; }
        .ink-drop { position: absolute; border-radius: 50%; background: var(--ink-blue); opacity: 0; animation: inkDrop 3s ease-out infinite; }
        .ink-drop:nth-child(1) { width: 24px; height: 24px; top: 38px; left: 38px; animation-delay: 0s; }
        .ink-drop:nth-child(2) { width: 18px; height: 18px; top: 42px; left: 50px; animation-delay: 0.8s; }
        .ink-drop:nth-child(3) { width: 14px; height: 14px; top: 35px; left: 32px; animation-delay: 1.6s; }
        @keyframes inkDrop {
            0% { transform: scale(0); opacity: 0.8; }
            40% { transform: scale(3); opacity: 0.15; }
            100% { transform: scale(5); opacity: 0; }
        }
        .ink-animation .brush-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 36px; z-index: 2; animation: brushPulse 2s ease-in-out infinite; }
        @keyframes brushPulse { 0%, 100% { transform: translate(-50%, -50%) scale(1); } 50% { transform: translate(-50%, -50%) scale(1.1); } }
        .loading-title { font-family: 'Noto Serif SC', serif; color: var(--ink); font-weight: 700; font-size: 1.25rem; margin-bottom: 8px; letter-spacing: 2px; }
        .loading-subtitle { color: var(--grey-text); font-size: 0.88rem; margin-bottom: 32px; }
        .progress-steps { display: flex; justify-content: center; gap: 0; margin-bottom: 32px; position: relative; }
        .step { display: flex; flex-direction: column; align-items: center; flex: 1; max-width: 120px; position: relative; }
        .step .step-icon { width: 40px; height: 40px; border-radius: 50%; background: var(--paper-dark); display: flex; align-items: center; justify-content: center; font-size: 1rem; transition: all 0.5s; position: relative; z-index: 2; border: 2px solid var(--paper-dark); }
        .step.active .step-icon { background: var(--ink-blue); border-color: var(--ink-blue); box-shadow: 0 0 0 4px rgba(44,62,107,0.12); animation: stepGlow 1.5s ease-in-out infinite; }
        .step.done .step-icon { background: var(--gold); border-color: var(--gold); box-shadow: 0 2px 8px rgba(196,160,85,0.25); }
        @keyframes stepGlow { 0%, 100% { box-shadow: 0 0 0 4px rgba(44,62,107,0.12); } 50% { box-shadow: 0 0 0 8px rgba(44,62,107,0.08); } }
        .step .step-label { margin-top: 8px; font-size: 0.72rem; color: var(--grey-light); transition: color 0.3s; text-align: center; }
        .step.active .step-label { color: var(--ink-blue); font-weight: 600; }
        .step.done .step-label { color: var(--gold-dark); font-weight: 500; }
        .progress-steps::before { content: ''; position: absolute; top: 20px; left: 15%; right: 15%; height: 2px; background: var(--paper-dark); z-index: 0; }
        .loading-timer { font-family: 'Noto Serif SC', serif; font-size: 2rem; font-weight: 700; color: var(--gold-dark); margin-bottom: 8px; letter-spacing: 2px; }
        .loading-timer-label { font-size: 0.78rem; color: var(--grey-light); margin-bottom: 28px; }
        .loading-preview { display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 28px; }
        .loading-preview img { width: 64px; height: 64px; object-fit: cover; border-radius: 6px; border: 2px solid var(--paper-dark); }
        .loading-preview .preview-info { text-align: left; }
        .loading-preview .preview-info .fname { font-size: 0.85rem; color: var(--charcoal); font-weight: 500; }
        .loading-preview .preview-info .fsize { font-size: 0.75rem; color: var(--grey-light); margin-top: 2px; }
        .tips-section { background: linear-gradient(135deg, #f8f1e4, #f5ecdb); border: 1px solid rgba(196,160,85,0.15); border-radius: 10px; padding: 20px 24px; margin-top: 4px; min-height: 100px; }
        .tips-section .tip-header { font-family: 'Noto Serif SC', serif; font-size: 0.78rem; color: var(--gold-dark); font-weight: 600; margin-bottom: 10px; letter-spacing: 2px; display: flex; align-items: center; gap: 6px; }
        .tips-section .tip-content { font-size: 0.9rem; color: #5c4a2f; line-height: 1.8; min-height: 48px; transition: opacity 0.4s; }
        .tips-section .tip-dots { display: flex; justify-content: center; gap: 6px; margin-top: 14px; }
        .tips-section .tip-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--grey-light); transition: all 0.3s; }
        .tips-section .tip-dot.active { background: var(--gold); transform: scale(1.3); }

        /* AI Stream */
        .ai-stream-section { display: none; margin-top: 20px; text-align: left; }
        .ai-stream-section.visible { display: block; }
        .ai-stream-header { font-family: 'Noto Serif SC', serif; font-size: 0.82rem; color: var(--gold-dark); font-weight: 600; margin-bottom: 10px; letter-spacing: 2px; display: flex; align-items: center; gap: 6px; }
        .ai-stream-box {
            background: linear-gradient(135deg, #faf7f0, #f5efe3); border: 1px solid rgba(196,160,85,0.2); border-radius: 8px;
            padding: 16px 20px; max-height: 200px; overflow-y: auto; font-family: 'Noto Sans SC', monospace;
            font-size: 0.85rem; line-height: 1.7; color: #4a4035; word-break: break-all; white-space: pre-wrap;
        }
        .ai-stream-box .cursor-blink { display: inline-block; width: 2px; height: 1em; background: var(--ink-blue); margin-left: 2px; vertical-align: text-bottom; animation: cursorBlink 0.8s steps(1) infinite; }
        @keyframes cursorBlink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        .ai-stream-box .highlight-title { color: var(--gold-dark); font-weight: 700; background: rgba(196,160,85,0.1); padding: 2px 6px; border-radius: 4px; }
        .ai-stream-box .score-hl { color: var(--cinnabar); font-weight: 600; }
        .ai-stream-box .suggestion-hl { color: var(--ink-blue); font-weight: 600; background: rgba(44,62,107,0.08); padding: 0 4px; border-radius: 2px; }

        /* ==================== Results Layout ==================== */
        .results-section { display: none; }
        .results-section.visible { display: block; }
        .results-layout { display: grid; grid-template-columns: 320px 1fr; gap: 30px; align-items: start; }
        .left-panel { position: sticky; top: 20px; }
        .original-image-card { background: var(--cream-light); border-radius: 12px; box-shadow: 0 4px 24px rgba(0,0,0,0.06); border: 1px solid rgba(196,160,85,0.15); padding: 24px; text-align: center; }
        .original-image-card .panel-title { font-family: 'Noto Serif SC', serif; font-size: 0.95rem; color: var(--grey-text); margin-bottom: 20px; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .scroll-frame { position: relative; display: inline-block; padding: 12px; background: linear-gradient(135deg, #e8dfd0, #ddd4c4); border-radius: 4px; box-shadow: 0 3px 12px rgba(0,0,0,0.1); }
        .scroll-frame::before { content: ''; position: absolute; top: 4px; left: 4px; right: 4px; bottom: 4px; border: 1px solid rgba(196,160,85,0.3); border-radius: 2px; pointer-events: none; }
        .scroll-frame img { max-width: 100%; max-height: 280px; display: block; border-radius: 2px; }
        .original-image-card .file-info { margin-top: 14px; font-size: 0.78rem; color: var(--grey-light); }
        .left-panel .btn-wrap { text-align: center; margin-top: 24px; }

        /* Right Panel */
        .right-panel .card { padding: 32px; background: var(--cream-light); position: relative; overflow: hidden; }
        .right-panel .card::before { content: ''; position: absolute; top: 0; right: 0; width: 200px; height: 200px; background: radial-gradient(circle, rgba(196,160,85,0.04) 0%, transparent 70%); pointer-events: none; }
        .results-title { font-family: 'Noto Serif SC', serif; font-size: 1.6rem; font-weight: 700; color: var(--ink); letter-spacing: 2px; }
        .card-header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-copy { background: transparent; border: 1px solid var(--grey-light); color: var(--grey-text); padding: 6px 14px; font-size: 0.85rem; border-radius: 4px; cursor: pointer; transition: all 0.3s; font-family: 'Noto Sans SC', sans-serif; display: flex; align-items: center; gap: 6px; }
        .btn-copy:hover { border-color: var(--gold); color: var(--gold-dark); background: rgba(196,160,85,0.05); }
        .meta-info { display: flex; gap: 20px; font-size: 0.8rem; color: var(--grey-light); margin-bottom: 20px; letter-spacing: 0.5px; }

        /* Score Cards */
        .summary-bar { display: flex; gap: 14px; margin-bottom: 28px; flex-wrap: wrap; }
        .stat-card { flex: 1; min-width: 100px; background: linear-gradient(160deg, var(--cream-light), var(--paper)); border-radius: 12px; padding: 20px 12px 16px; text-align: center; border: 1px solid rgba(196,160,85,0.12); box-shadow: 0 2px 12px rgba(0,0,0,0.04); }
        .stat-card .stat-icon { font-size: 1.2rem; margin-bottom: 4px; display: block; opacity: 0.7; }
        .stat-card .score { font-family: 'Noto Serif SC', serif; font-size: 2rem; font-weight: 900; color: var(--gold-dark); line-height: 1.1; }
        .stat-card .label { font-size: 0.78rem; color: var(--grey-text); margin-top: 6px; letter-spacing: 1px; }

        /* Summary Comment */
        .summary-scroll { position: relative; background: linear-gradient(135deg, #f8f1e4, #f5ecdb); border: 1px solid rgba(196,160,85,0.2); border-radius: 8px; padding: 20px 24px; margin-bottom: 28px; overflow: hidden; }
        .summary-scroll::after { content: ''; position: absolute; bottom: 8px; right: 12px; width: 32px; height: 32px; background: var(--cinnabar); opacity: 0.08; border-radius: 2px; transform: rotate(-3deg); }
        .summary-scroll .scroll-text { font-size: 0.95rem; line-height: 1.8; color: #5c4a2f; position: relative; z-index: 1; }

        /* Section header */
        .section-header { font-family: 'Noto Serif SC', serif; font-size: 1.15rem; font-weight: 700; color: var(--ink); margin-bottom: 18px; display: flex; align-items: center; gap: 8px; letter-spacing: 1px; }
        .section-header::after { content: ''; flex: 1; height: 1px; background: linear-gradient(90deg, rgba(196,160,85,0.3), transparent); margin-left: 12px; }

        /* Character Cards */
        .char-list { display: flex; flex-direction: column; gap: 16px; }
        .char-card { border: 1px solid rgba(196,160,85,0.15); border-radius: 10px; overflow: hidden; transition: all 0.3s; background: var(--cream-light); }
        .char-card:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.07); border-color: rgba(196,160,85,0.25); }
        .char-card .char-header { display: flex; align-items: center; gap: 14px; padding: 16px 20px; background: linear-gradient(135deg, var(--paper), var(--cream-light)); border-bottom: 1px solid rgba(196,160,85,0.1); }
        .char-card .char-crop-wrap { flex-shrink: 0; width: 60px; height: 60px; border-radius: 6px; overflow: hidden; border: 2px solid rgba(196,160,85,0.3); background: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.15s; }
        .char-card .char-crop-wrap:active { transform: scale(0.95); }
        .char-card .char-crop-img { width: 100%; height: 100%; object-fit: cover; }
        .char-card .char-index { width: 36px; height: 36px; background: var(--cinnabar); color: #fff; border-radius: 3px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 0.85rem; font-family: 'Noto Serif SC', serif; flex-shrink: 0; box-shadow: 0 2px 8px rgba(194,58,46,0.2); transform: rotate(-2deg); }
        .char-card .char-info { display: flex; flex-direction: column; gap: 2px; }
        .char-card .char-name { font-family: 'Noto Serif SC', serif; font-size: 1.4rem; font-weight: 700; color: var(--ink); }
        .char-card .char-pos { font-size: 0.75rem; color: var(--grey-text); font-weight: 400; }
        .char-card .char-score { margin-left: auto; font-family: 'Noto Serif SC', serif; font-size: 1.8rem; font-weight: 900; color: var(--gold-dark); }
        .score-high { color: #2d7d46 !important; }
        .score-mid { color: var(--gold-dark) !important; }
        .score-low { color: var(--cinnabar) !important; }
        .char-card .char-body { padding: 18px 20px; }
        .char-card .detail-row { display: flex; align-items: center; padding: 8px 0; font-size: 0.88rem; }
        .char-card .detail-row .detail-label { color: var(--grey-text); flex-shrink: 0; width: 36px; font-weight: 500; }
        .char-card .brush-bar { flex: 1; height: 8px; margin: 0 14px; background: rgba(196,160,85,0.1); border-radius: 4px; overflow: hidden; }
        .char-card .brush-fill { height: 100%; border-radius: 4px; transition: width 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94); background: linear-gradient(90deg, var(--ink-blue), var(--indigo-light), var(--gold)); }
        .char-card .comment-section { margin-top: 14px; padding-top: 14px; border-top: 1px solid rgba(196,160,85,0.1); position: relative; }
        .char-card .comment-section::before { content: '~'; position: absolute; top: -8px; left: 50%; transform: translateX(-50%); background: var(--cream-light); padding: 0 12px; color: var(--grey-light); font-size: 0.9rem; }
        .char-card .comment-text { font-size: 0.9rem; color: #4a4035; line-height: 1.7; }
        .char-card .suggestion { margin-top: 10px; font-size: 0.84rem; color: var(--cinnabar); background: rgba(194,58,46,0.04); border: 1px solid rgba(194,58,46,0.1); padding: 10px 14px; border-radius: 6px; line-height: 1.6; }
        .char-card .detail-row .score-num { font-weight: 600; color: var(--charcoal); min-width: 28px; text-align: right; }

        /* ==================== Single Char Result ==================== */
        .single-result-section { display: none; }
        .single-result-section.visible { display: block; }
        .single-result-card { background: var(--cream-light); border-radius: 12px; box-shadow: 0 4px 24px rgba(0,0,0,0.06); border: 1px solid rgba(196,160,85,0.15); padding: 32px; max-width: 700px; margin: 0 auto; }
        .single-char-display { text-align: center; margin-bottom: 24px; }
        .single-char-display img { max-width: 200px; max-height: 200px; border-radius: 8px; border: 3px solid var(--paper-dark); box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
        .single-char-display .char-label { font-family: 'Noto Serif SC', serif; font-size: 2rem; font-weight: 900; color: var(--ink); margin-top: 12px; }
        .single-scores-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 24px; }
        .single-score-item { text-align: center; padding: 12px 4px; background: linear-gradient(160deg, var(--cream-light), var(--paper)); border-radius: 8px; border: 1px solid rgba(196,160,85,0.12); }
        .single-score-item .s-val { font-family: 'Noto Serif SC', serif; font-size: 1.4rem; font-weight: 900; color: var(--gold-dark); }
        .single-score-item .s-label { font-size: 0.72rem; color: var(--grey-text); margin-top: 4px; }
        .analysis-block { margin-bottom: 16px; }
        .analysis-block .ab-title { font-family: 'Noto Serif SC', serif; font-size: 0.95rem; font-weight: 700; color: var(--ink); margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
        .analysis-block .ab-content { font-size: 0.9rem; color: #4a4035; line-height: 1.8; padding-left: 24px; }
        .suggestion-block { background: rgba(194,58,46,0.04); border: 1px solid rgba(194,58,46,0.1); padding: 14px 18px; border-radius: 8px; margin-top: 20px; }
        .suggestion-block .sb-title { font-family: 'Noto Serif SC', serif; font-size: 0.95rem; font-weight: 700; color: var(--cinnabar); margin-bottom: 8px; }
        .suggestion-block .sb-content { font-size: 0.88rem; color: #4a4035; line-height: 1.8; white-space: pre-line; }

        /* ==================== Lightbox ==================== */
        .char-lightbox { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 9999; background: rgba(0,0,0,0.7); align-items: center; justify-content: center; flex-direction: column; gap: 12px; padding: 20px; backdrop-filter: blur(4px); }
        .char-lightbox.visible { display: flex; }
        .char-lightbox-inner { position: relative; background: #fff; border-radius: 12px; padding: 12px; box-shadow: 0 8px 40px rgba(0,0,0,0.3); max-width: 90vw; max-height: 70vh; }
        .char-lightbox-img { display: block; max-width: 100%; max-height: 60vh; border-radius: 6px; image-rendering: pixelated; }
        .char-lightbox-label { text-align: center; font-family: 'Noto Serif SC', serif; color: #fff; font-size: 1rem; }
        .char-lightbox-label .lb-char { font-size: 1.4rem; font-weight: 700; }
        .char-lightbox-label .lb-pos { font-size: 0.85rem; opacity: 0.8; margin-left: 8px; }
        .char-lightbox-close { position: absolute; top: -12px; right: -12px; width: 32px; height: 32px; border-radius: 50%; background: var(--cinnabar); color: #fff; border: 2px solid #fff; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }

        /* ==================== Footer ==================== */
        .footer { text-align: center; color: var(--grey-light); margin-top: 48px; font-size: 0.8rem; letter-spacing: 2px; }
        .footer .footer-line { display: flex; align-items: center; justify-content: center; gap: 12px; }
        .footer .footer-line::before, .footer .footer-line::after { content: ''; width: 40px; height: 1px; background: linear-gradient(90deg, transparent, var(--grey-light), transparent); }

        /* ==================== Responsive ==================== */
        @media (max-width: 900px) {
            .results-layout { grid-template-columns: 1fr; gap: 20px; }
            .left-panel { position: static; }
        }
        @media (max-width: 768px) {
            body { -webkit-text-size-adjust: 100%; }
            body::after { height: 160px; }
            .container { padding: 16px 12px; padding-top: max(16px, env(safe-area-inset-top)); padding-bottom: max(16px, env(safe-area-inset-bottom)); }
            .header { margin-bottom: 16px; }
            .header h1 { font-size: 1.75rem; letter-spacing: 4px; }
            .header h1::after { width: 80px; }
            .header p { font-size: 0.82rem; letter-spacing: 1px; margin-top: 12px; }
            .mode-tabs { max-width: 100%; margin-bottom: 16px; }
            .mode-tab { font-size: 0.88rem; padding: 9px 12px; letter-spacing: 1px; }
            .card { padding: 20px 16px; margin-bottom: 16px; border-radius: 10px; }
            .template-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; }
            .template-card { padding: 10px 6px; }
            .template-card .tpl-name { font-size: 0.78rem; }
            .template-card .tpl-icon { font-size: 1.2rem; }
            .upload-area { padding: 40px 16px; border-radius: 10px; }
            .upload-area .icon { font-size: 40px; margin-bottom: 10px; }
            .upload-area h3 { font-size: 1rem; }
            .preview-img { max-height: 200px; }
            .btn-primary { display: block; width: 100%; padding: 14px 20px; font-size: 1rem; letter-spacing: 3px; }
            .btn-seal { display: block; width: 100%; padding: 12px 20px; text-align: center; letter-spacing: 4px; }
            .crop-canvas-wrap { width: 100%; }
            .crop-canvas-wrap canvas { max-width: 100%; width: auto; height: auto; }
            .crop-magnifier { width: 120px; height: 120px; border-width: 2px; }
            .crop-actions { flex-direction: column; }
            .loading { padding: 16px 0; }
            .loading-card { padding: 28px 16px 24px; border-radius: 12px; }
            .ink-animation { width: 72px; height: 72px; margin-bottom: 16px; }
            .ink-animation .brush-center { font-size: 28px; }
            .loading-title { font-size: 1.1rem; }
            .loading-subtitle { font-size: 0.8rem; margin-bottom: 20px; }
            .loading-preview img { width: 48px; height: 48px; }
            .loading-preview .preview-info .fname { font-size: 0.78rem; max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
            .progress-steps { margin-bottom: 20px; }
            .step .step-icon { width: 32px; height: 32px; font-size: 0.8rem; }
            .step .step-label { font-size: 0.65rem; }
            .progress-steps::before { top: 16px; }
            .loading-timer { font-size: 1.6rem; }
            .loading-timer-label { margin-bottom: 16px; }
            .tips-section { padding: 14px 16px; min-height: 80px; }
            .tips-section .tip-content { font-size: 0.82rem; line-height: 1.7; }
            .ai-stream-box { max-height: 240px; padding: 14px; font-size: 0.82rem; word-break: break-word; }
            .results-layout { grid-template-columns: 1fr; gap: 16px; }
            .left-panel { position: static; }
            .original-image-card { padding: 14px; }
            .original-image-card .panel-title { font-size: 0.82rem; margin-bottom: 12px; }
            .scroll-frame { padding: 6px; }
            .scroll-frame img { max-height: 160px; }
            .right-panel .card { padding: 20px 14px; }
            .card-header-flex { margin-bottom: 12px; }
            .results-title { font-size: 1.25rem; letter-spacing: 1px; }
            .meta-info { flex-wrap: wrap; gap: 6px 14px; font-size: 0.72rem; margin-bottom: 14px; }
            .summary-bar { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px; }
            .stat-card { min-width: unset; padding: 14px 8px 12px; border-radius: 8px; }
            .stat-card .score { font-size: 1.6rem; }
            .stat-card .label { font-size: 0.72rem; }
            .summary-scroll { padding: 14px 16px; margin-bottom: 16px; }
            .section-header { font-size: 1rem; margin-bottom: 12px; }
            .char-list { gap: 12px; }
            .char-card .char-header { padding: 12px 14px; gap: 10px; }
            .char-card .char-crop-wrap { width: 50px; height: 50px; }
            .char-card .char-name { font-size: 1.1rem; }
            .char-card .char-score { font-size: 1.5rem; }
            .char-card .char-body { padding: 14px; }
            .char-card .detail-row { font-size: 0.82rem; padding: 6px 0; }
            .char-card .brush-bar { margin: 0 10px; height: 6px; }
            .char-card .comment-text { font-size: 0.82rem; }
            .char-card .suggestion { font-size: 0.78rem; padding: 8px 12px; }
            /* Single char result */
            .single-result-card { padding: 20px 14px; }
            .single-scores-grid { grid-template-columns: repeat(3, 1fr); }
            .single-score-item .s-val { font-size: 1.2rem; }
            .footer { margin-top: 28px; font-size: 0.72rem; }
        }
        @media (max-width: 380px) {
            .header h1 { font-size: 1.5rem; letter-spacing: 2px; }
            .stat-card .score { font-size: 1.4rem; }
            .single-scores-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>AI书法批改助手</h1>
        <p>上传书法作业照片，AI 智能分析结构与笔画，给出专业点评</p>
    </div>

    <!-- Mode Tabs -->
    <div class="mode-tabs" id="modeTabs">
        <button class="mode-tab active" data-mode="whole" onclick="switchMode('whole')">整页批改</button>
        <button class="mode-tab" data-mode="single" onclick="switchMode('single')">单字精批</button>
    </div>

    <!-- ==================== Whole Page Mode ==================== -->
    <div id="wholePageMode">
        <div class="card" id="uploadCard">
            <!-- Template Selector -->
            <div class="template-section" id="templateSection">
                <div class="section-label">
                    <span>&#128218;</span>
                    <span>选择字帖模板</span>
                </div>
                <div class="template-grid" id="templateGrid">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Desktop Upload -->
            <div class="upload-area desktop-upload" id="uploadArea">
                <div class="icon">&#128396;</div>
                <h3>点击或拖拽上传书法作业照片</h3>
                <p>支持 JPG、PNG 格式，建议竖拍整页</p>
                <input type="file" id="fileInput" accept="image/jpeg,image/png,image/webp">
            </div>

            <!-- Mobile Upload -->
            <div class="mobile-upload" id="mobileUpload" style="display:none;">
                <div class="mobile-upload-btns">
                    <label class="mobile-upload-btn camera-btn">
                        <span class="mobile-btn-icon">&#128247;</span>
                        <span class="mobile-btn-text">拍照上传</span>
                        <span class="mobile-btn-hint">竖拍整页效果最佳</span>
                        <input type="file" id="cameraInput" accept="image/*" capture="environment">
                    </label>
                    <label class="mobile-upload-btn album-btn">
                        <span class="mobile-btn-icon">&#128444;</span>
                        <span class="mobile-btn-text">从相册选择</span>
                        <span class="mobile-btn-hint">选择之前拍好的照片</span>
                        <input type="file" id="albumInput" accept="image/jpeg,image/png,image/webp">
                    </label>
                </div>
            </div>

            <div class="preview-section" id="previewSection">
                <div class="scroll-frame"><img id="previewImg" alt="预览"></div>
                <div class="preview-info-bar" id="previewInfoBar"></div>
                <button class="btn-primary" id="analyzeBtn" onclick="submitAnalysis()">开始批改</button>
                <button class="btn-reselect" onclick="reselectImage()">重新选择</button>
            </div>
        </div>
    </div>

    <!-- ==================== Single Char Mode ==================== -->
    <div id="singleCharMode" style="display:none;">
        <div class="card" id="singleUploadCard">
            <div class="section-label" style="font-family:'Noto Serif SC',serif;font-size:0.92rem;font-weight:600;color:var(--charcoal);margin-bottom:16px;letter-spacing:1px;display:flex;align-items:center;gap:6px;">
                <span>&#9998;</span>
                <span>单字精批 — 深度分析一个字</span>
            </div>

            <!-- Direct Upload -->
            <div class="upload-area desktop-upload" id="singleUploadArea">
                <div class="icon">&#9998;</div>
                <h3>上传或拍摄单个字的照片</h3>
                <p>对准练习纸上的一个字拍照，AI 将进行深度分析</p>
                <input type="file" id="singleFileInput" accept="image/jpeg,image/png,image/webp">
            </div>

            <!-- Mobile Single Upload -->
            <div class="mobile-upload" id="singleMobileUpload" style="display:none;">
                <div class="mobile-upload-btns">
                    <label class="mobile-upload-btn camera-btn">
                        <span class="mobile-btn-icon">&#128247;</span>
                        <span class="mobile-btn-text">拍照</span>
                        <span class="mobile-btn-hint">对准单个字拍照</span>
                        <input type="file" id="singleCameraInput" accept="image/*" capture="environment">
                    </label>
                    <label class="mobile-upload-btn album-btn">
                        <span class="mobile-btn-icon">&#128444;</span>
                        <span class="mobile-btn-text">选图</span>
                        <span class="mobile-btn-hint">从相册选择</span>
                        <input type="file" id="singleAlbumInput" accept="image/jpeg,image/png,image/webp">
                    </label>
                </div>
            </div>

            <!-- Or: Crop from whole page -->
            <div style="text-align:center;margin:20px 0 12px;color:var(--grey-light);font-size:0.85rem;">
                ── 或从整页作业中框选 ──
            </div>
            <div style="text-align:center;">
                <label class="btn-secondary" style="cursor:pointer;position:relative;">
                    上传整页照片，然后框选
                    <input type="file" id="cropPageInput" accept="image/jpeg,image/png,image/webp"
                           style="position:absolute;width:100%;height:100%;top:0;left:0;opacity:0;cursor:pointer;">
                </label>
            </div>

            <!-- Crop Area -->
            <div class="crop-section" id="cropSection">
                <div class="crop-hint">在图片上拖拽框选要精批的字；支持双指捏合缩放整图。</div>
                <div class="crop-canvas-wrap" id="cropCanvasWrap">
                    <canvas id="cropCanvas"></canvas>
                    <div class="crop-magnifier" id="cropMagnifier">
                        <canvas id="cropMagnifierCanvas" width="132" height="132"></canvas>
                    </div>
                </div>
                <div class="crop-actions">
                    <button class="btn-secondary" onclick="resetCrop()">重新框选</button>
                    <button class="btn-primary" id="cropSubmitBtn" style="margin-top:0;padding:10px 28px;font-size:0.92rem;letter-spacing:2px;" disabled onclick="submitCroppedChar()">开始精批</button>
                </div>
            </div>

            <!-- Single Char Preview -->
            <div class="preview-section" id="singlePreviewSection">
                <div class="scroll-frame"><img id="singlePreviewImg" alt="预览"></div>
                <div class="preview-info-bar" id="singlePreviewInfoBar"></div>
                <button class="btn-primary" id="singleAnalyzeBtn" onclick="submitSingleAnalysis()">开始精批</button>
                <button class="btn-reselect" onclick="reselectSingleImage()">重新选择</button>
            </div>
        </div>
    </div>

    <!-- ==================== Loading (Shared) ==================== -->
    <div class="loading" id="loadingSection">
        <div class="loading-card">
            <div class="ink-animation">
                <div class="ink-drop"></div><div class="ink-drop"></div><div class="ink-drop"></div>
                <div class="brush-center">&#9997;</div>
            </div>
            <div class="loading-title" id="loadingTitle">墨迹识别中</div>
            <div class="loading-subtitle" id="loadingSubtitle">AI 正在细察每一笔一画</div>
            <div class="loading-preview">
                <img id="loadingPreviewImg" alt="">
                <div class="preview-info">
                    <div class="fname" id="loadingFileName"></div>
                    <div class="fsize" id="loadingFileSize"></div>
                </div>
            </div>
            <div class="progress-steps" id="progressSteps">
                <div class="step active" id="step0"><div class="step-icon">&#128444;</div><div class="step-label">图像处理</div></div>
                <div class="step" id="step1"><div class="step-icon">&#128300;</div><div class="step-label">字符识别</div></div>
                <div class="step" id="step2"><div class="step-icon">&#129504;</div><div class="step-label">AI 分析</div></div>
                <div class="step" id="step3"><div class="step-icon">&#128220;</div><div class="step-label">生成报告</div></div>
            </div>
            <div class="loading-timer" id="loadingTimer">0.0s</div>
            <div class="loading-timer-label">已用时</div>
            <div class="tips-section">
                <div class="tip-header"><span>&#128218;</span><span>书法小知识</span></div>
                <div class="tip-content" id="tipContent"></div>
                <div class="tip-dots" id="tipDots"></div>
            </div>
            <div class="ai-stream-section" id="aiStreamSection">
                <div class="ai-stream-header"><span>&#129302;</span><span>AI 正在分析</span></div>
                <div class="ai-stream-box" id="aiStreamBox"><span class="cursor-blink"></span></div>
            </div>
        </div>
    </div>

    <!-- ==================== Whole Page Results ==================== -->
    <div class="results-section" id="resultsSection">
        <div class="results-layout">
            <div class="left-panel">
                <div class="original-image-card">
                    <div class="panel-title"><span class="brush-icon">&#9997;</span><span>原始作业</span></div>
                    <div class="scroll-frame"><img id="resultOriginalImg" alt="原始作业"></div>
                    <div class="file-info" id="fileInfoText"></div>
                </div>
                <div class="btn-wrap"><button class="btn-seal" onclick="resetPage()">再批一份</button></div>
            </div>
            <div class="right-panel">
                <div class="card">
                    <div class="card-header-flex">
                        <h2 class="results-title">批改结果</h2>
                        <button class="btn-copy" onclick="copyFullReport()"><span>&#128203;</span> 复制报告</button>
                    </div>
                    <div class="meta-info" id="metaInfo"></div>
                    <div class="summary-bar" id="summaryBar"></div>
                    <div class="summary-scroll" id="summaryComment"><div class="scroll-text"></div></div>
                    <div class="section-header"><span class="section-icon">&#9757;</span><span>重点字点评</span></div>
                    <div class="char-list" id="charGrid"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== Single Char Results ==================== -->
    <div class="single-result-section" id="singleResultSection">
        <div class="single-result-card">
            <div class="card-header-flex">
                <h2 class="results-title">单字精批报告</h2>
                <button class="btn-copy" onclick="copyFullReport()"><span>&#128203;</span> 复制报告</button>
            </div>
            <div class="single-char-display" id="singleCharDisplay"></div>
            <div class="single-scores-grid" id="singleScoresGrid"></div>
            <div id="singleAnalysisBlocks"></div>
            <div class="suggestion-block" id="singleSuggestionBlock" style="display:none;">
                <div class="sb-title">&#9998; 练习建议</div>
                <div class="sb-content" id="singleSuggestionContent"></div>
            </div>
            <div style="text-align:center;margin-top:24px;">
                <button class="btn-seal" onclick="resetPage()">再批一个</button>
            </div>
        </div>
    </div>

    <div class="footer"><div class="footer-line"><span>墨韵 AI &middot; 书法批改助手 v2.0</span></div></div>
</div>

<!-- Lightbox -->
<div class="char-lightbox" id="charLightbox" onclick="closeCharLightbox(event)">
    <div class="char-lightbox-inner">
        <button class="char-lightbox-close" onclick="closeCharLightbox(event)">&times;</button>
        <img class="char-lightbox-img" id="charLightboxImg" alt="">
    </div>
    <div class="char-lightbox-label" id="charLightboxLabel"></div>
</div>

<script>
// ==================== State ====================
var currentMode = 'whole'; // 'whole' | 'single'
var selectedFile = null;
var singleSelectedFile = null;
var previewDataUrl = null;
var singlePreviewDataUrl = null;
var selectedTemplateId = null;
var templates = [];
var streamedText = '';
var aiOutputStarted = false;

// ==================== DOM Refs ====================
var fileInput = document.getElementById('fileInput');
var cameraInput = document.getElementById('cameraInput');
var albumInput = document.getElementById('albumInput');
var uploadArea = document.getElementById('uploadArea');
var mobileUpload = document.getElementById('mobileUpload');
var previewSection = document.getElementById('previewSection');
var previewImg = document.getElementById('previewImg');
var loadingSection = document.getElementById('loadingSection');
var resultsSection = document.getElementById('resultsSection');
var uploadCard = document.getElementById('uploadCard');

// ==================== Environment Detection ====================
var isWechat = /MicroMessenger/i.test(navigator.userAgent);
var isMobile = isWechat || /Android|iPhone|iPad|iPod|webOS/i.test(navigator.userAgent) || window.innerWidth <= 768;

function setupMobileUpload() {
    if (isWechat) {
        uploadArea.style.display = 'none';
        mobileUpload.style.display = 'block';
        document.querySelector('#mobileUpload .camera-btn').style.display = 'none';
        var albumBtn = document.querySelector('#mobileUpload .album-btn');
        albumBtn.querySelector('.mobile-btn-text').textContent = '点击上传书法作业';
        albumBtn.querySelector('.mobile-btn-hint').textContent = '微信将弹出拍照或选相册';
        albumBtn.querySelector('.mobile-btn-icon').innerHTML = '&#128396;';
        albumBtn.style.maxWidth = '280px';
        albumBtn.style.margin = '0 auto';
        albumInput.removeAttribute('capture');
        // Single char mode
        document.getElementById('singleUploadArea').style.display = 'none';
        document.getElementById('singleMobileUpload').style.display = 'block';
    } else if (isMobile) {
        uploadArea.style.display = 'none';
        mobileUpload.style.display = 'block';
        document.getElementById('singleUploadArea').style.display = 'none';
        document.getElementById('singleMobileUpload').style.display = 'block';
    }
}
setupMobileUpload();

// ==================== Mode Switching ====================
function switchMode(mode) {
    currentMode = mode;
    document.querySelectorAll('.mode-tab').forEach(function(t) {
        t.classList.toggle('active', t.dataset.mode === mode);
    });
    document.getElementById('wholePageMode').style.display = mode === 'whole' ? 'block' : 'none';
    document.getElementById('singleCharMode').style.display = mode === 'single' ? 'block' : 'none';
    // Hide results when switching
    resultsSection.classList.remove('visible');
    document.getElementById('singleResultSection').classList.remove('visible');
    loadingSection.classList.remove('visible');
}

// ==================== Template Loading ====================
function loadTemplates() {
    fetch('/api/homework/templates')
        .then(function(r) { return r.json(); })
        .then(function(resp) {
            if (resp.success && resp.data) {
                templates = resp.data;
                renderTemplateGrid();
            }
        })
        .catch(function(e) { console.warn('加载模板失败:', e); });
}

function renderTemplateGrid() {
    var grid = document.getElementById('templateGrid');
    // Free mode card
    var html = '<div class="template-card free-mode selected" data-id="" onclick="selectTemplate(null, this)">' +
        '<span class="tpl-icon">&#128196;</span>' +
        '<div class="tpl-name">自由模式</div>' +
        '<div class="tpl-desc">不限字帖</div></div>';

    var typeIcons = { TIAN: '&#9608;', MI: '&#10010;', HUI: '&#9635;', PLAIN: '&#9633;' };
    templates.forEach(function(t) {
        html += '<div class="template-card" data-id="' + t.id + '" onclick="selectTemplate(' + t.id + ', this)">' +
            '<span class="tpl-icon">' + (typeIcons[t.gridType] || '&#9633;') + '</span>' +
            '<div class="tpl-name">' + t.name + '</div>' +
            '<div class="tpl-desc">' + t.gridRows + '行' + t.gridCols + '列</div></div>';
    });
    grid.innerHTML = html;
}

function selectTemplate(id, el) {
    selectedTemplateId = id;
    document.querySelectorAll('.template-card').forEach(function(c) { c.classList.remove('selected'); });
    if (el) el.classList.add('selected');
}

loadTemplates();

// ==================== File Handling (Whole Page) ====================
fileInput.addEventListener('change', function(e) { if (e.target.files[0]) handleFileSelect(e.target.files[0]); });
cameraInput.addEventListener('change', function(e) { if (e.target.files[0]) handleFileSelect(e.target.files[0]); });
albumInput.addEventListener('change', function(e) { if (e.target.files[0]) handleFileSelect(e.target.files[0]); });

function handleFileSelect(file) {
    if (file.size > 20 * 1024 * 1024) { alert('图片太大，请选择 20MB 以内的照片'); return; }
    selectedFile = file;
    var reader = new FileReader();
    reader.onload = function(ev) {
        previewDataUrl = ev.target.result;
        previewImg.src = previewDataUrl;
        var tempImg = new Image();
        tempImg.onload = function() {
            var sizeKB = (file.size / 1024).toFixed(0);
            var sizeMB = file.size > 1024 * 1024 ? ' (' + (file.size / 1024 / 1024).toFixed(1) + 'MB)' : ' (' + sizeKB + 'KB)';
            document.getElementById('previewInfoBar').textContent = tempImg.width + ' x ' + tempImg.height + sizeMB;
        };
        tempImg.src = previewDataUrl;
        uploadArea.style.display = 'none';
        mobileUpload.style.display = 'none';
        previewSection.classList.add('visible');
    };
    reader.readAsDataURL(file);
}

function reselectImage() {
    selectedFile = null; previewDataUrl = null;
    previewSection.classList.remove('visible');
    fileInput.value = ''; cameraInput.value = ''; albumInput.value = '';
    if (isMobile) { mobileUpload.style.display = 'block'; } else { uploadArea.style.display = 'block'; }
}

// Drag and drop
uploadArea.addEventListener('dragover', function(e) { e.preventDefault(); uploadArea.classList.add('dragover'); });
uploadArea.addEventListener('dragleave', function() { uploadArea.classList.remove('dragover'); });
uploadArea.addEventListener('drop', function(e) {
    e.preventDefault(); uploadArea.classList.remove('dragover');
    var file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) { fileInput.files = e.dataTransfer.files; handleFileSelect(file); }
});

// ==================== File Handling (Single Char) ====================
document.getElementById('singleFileInput').addEventListener('change', function(e) { if (e.target.files[0]) handleSingleFileSelect(e.target.files[0]); });
document.getElementById('singleCameraInput').addEventListener('change', function(e) { if (e.target.files[0]) handleSingleFileSelect(e.target.files[0]); });
document.getElementById('singleAlbumInput').addEventListener('change', function(e) { if (e.target.files[0]) handleSingleFileSelect(e.target.files[0]); });

function handleSingleFileSelect(file) {
    if (file.size > 20 * 1024 * 1024) { alert('图片太大，请选择 20MB 以内的照片'); return; }
    singleSelectedFile = file;
    var reader = new FileReader();
    reader.onload = function(ev) {
        singlePreviewDataUrl = ev.target.result;
        document.getElementById('singlePreviewImg').src = singlePreviewDataUrl;
        document.getElementById('singleUploadArea').style.display = 'none';
        document.getElementById('singleMobileUpload').style.display = 'none';
        document.getElementById('cropSection').classList.remove('visible');
        document.getElementById('singlePreviewSection').classList.add('visible');
    };
    reader.readAsDataURL(file);
}

function reselectSingleImage() {
    singleSelectedFile = null; singlePreviewDataUrl = null;
    document.getElementById('singlePreviewSection').classList.remove('visible');
    document.getElementById('singleFileInput').value = '';
    document.getElementById('singleCameraInput').value = '';
    document.getElementById('singleAlbumInput').value = '';
    if (isMobile) { document.getElementById('singleMobileUpload').style.display = 'block'; }
    else { document.getElementById('singleUploadArea').style.display = 'block'; }
}

// ==================== Crop from page ====================
var cropImg = null;
var croppedBlob = null;
var cropSelection = null;
var cropInteraction = {
    active: false,
    mode: null,      // 'draw' | 'move' | 'resize'
    handle: null,    // 'nw' | 'ne' | 'sw' | 'se'
    startX: 0,
    startY: 0,
    offsetX: 0,
    offsetY: 0,
    origin: null
};
var CROP_MIN_SIZE = 20;
var CROP_HANDLE_RADIUS = 8;
var CROP_MAGNIFIER_ZOOM = 3;
var cropView = {
    baseScale: 1,
    zoom: 1,
    minZoom: 1,
    maxZoom: 4,
    panX: 0,
    panY: 0
};
var pinchState = {
    active: false,
    startDistance: 0,
    startZoom: 1,
    startMidX: 0,
    startMidY: 0,
    startImgX: 0,
    startImgY: 0
};
var cropMagnifier = document.getElementById('cropMagnifier');
var cropMagnifierCanvas = document.getElementById('cropMagnifierCanvas');
var cropMagnifierCtx = cropMagnifierCanvas ? cropMagnifierCanvas.getContext('2d') : null;

document.getElementById('cropPageInput').addEventListener('change', function(e) {
    var file = e.target.files[0];
    if (!file) return;
    var reader = new FileReader();
    reader.onload = function(ev) {
        cropImg = new Image();
        cropImg.onload = function() {
            var canvas = document.getElementById('cropCanvas');
            var maxDisplayWidth = isMobile ? Math.min(window.innerWidth - 28, 520) : 640;
            var maxDisplayHeight = isMobile ? Math.min(window.innerHeight * 0.72, 680) : 760;
            maxDisplayWidth = Math.max(maxDisplayWidth, 240);
            maxDisplayHeight = Math.max(maxDisplayHeight, 240);
            var displayScale = Math.min(maxDisplayWidth / cropImg.width, maxDisplayHeight / cropImg.height, 1);
            var dpr = Math.max(1, Math.min(window.devicePixelRatio || 1, 2));
            var renderScale = Math.min(1, displayScale * dpr);
            canvas.width = Math.round(cropImg.width * renderScale);
            canvas.height = Math.round(cropImg.height * renderScale);
            canvas.style.width = Math.round(cropImg.width * displayScale) + 'px';
            canvas.style.height = Math.round(cropImg.height * displayScale) + 'px';
            cropView.baseScale = renderScale;
            cropView.zoom = 1;
            cropView.minZoom = 1;
            cropView.maxZoom = isMobile ? 4 : 3;
            cropView.panX = 0;
            cropView.panY = 0;
            clampCropViewPan();
            cropSelection = null;
            cropInteraction.active = false;
            pinchState.active = false;
            hideCropMagnifier();
            renderCropCanvas();

            var cropHint = document.querySelector('#cropSection .crop-hint');
            if (cropHint) {
                cropHint.textContent = isMobile
                    ? '先框大概范围，再拖动框或四角微调；支持双指捏合缩放整图。'
                    : '拖拽框选目标字，框内可移动，拖动四角可微调。';
            }

            document.getElementById('cropSection').classList.add('visible');
            document.getElementById('cropSubmitBtn').disabled = true;
            croppedBlob = null;
        };
        cropImg.src = ev.target.result;
    };
    reader.readAsDataURL(file);
});

var cropCanvas = document.getElementById('cropCanvas');
cropCanvas.addEventListener('mousedown', startCrop);
cropCanvas.addEventListener('mousemove', moveCrop);
window.addEventListener('mouseup', endCrop);
cropCanvas.addEventListener('touchstart', function(e) {
    e.preventDefault();
    if (e.touches.length >= 2) {
        beginPinch(e);
        return;
    }
    if (pinchState.active) return;
    var t = e.touches[0];
    if (t) startCrop(t);
}, {passive: false});
cropCanvas.addEventListener('touchmove', function(e) {
    e.preventDefault();
    if (e.touches.length >= 2) {
        if (!pinchState.active) beginPinch(e);
        else movePinch(e);
        return;
    }
    if (pinchState.active) return;
    var t = e.touches[0];
    if (t) moveCrop(t);
}, {passive: false});
window.addEventListener('touchend', function(e) {
    if (pinchState.active && e.touches.length < 2) {
        endPinch();
    }
    if (cropInteraction.active && e.touches.length === 0) {
        e.preventDefault();
        endCrop(e);
    }
}, {passive: false});
window.addEventListener('touchcancel', function(e) {
    if (pinchState.active) {
        endPinch();
    }
    if (cropInteraction.active) {
        e.preventDefault();
        endCrop(e);
    }
}, {passive: false});

function clamp(value, min, max) {
    return Math.max(min, Math.min(max, value));
}

function cloneSelection(sel) {
    return sel ? { x: sel.x, y: sel.y, w: sel.w, h: sel.h } : null;
}

function clampCropViewPan() {
    if (!cropImg) return;
    var drawScale = cropView.baseScale * cropView.zoom;
    var drawW = cropImg.width * drawScale;
    var drawH = cropImg.height * drawScale;
    if (drawW <= cropCanvas.width) {
        cropView.panX = (cropCanvas.width - drawW) / 2;
    } else {
        cropView.panX = clamp(cropView.panX, cropCanvas.width - drawW, 0);
    }
    if (drawH <= cropCanvas.height) {
        cropView.panY = (cropCanvas.height - drawH) / 2;
    } else {
        cropView.panY = clamp(cropView.panY, cropCanvas.height - drawH, 0);
    }
}

function getTouchDistance(touches) {
    if (!touches || touches.length < 2) return 0;
    var dx = touches[0].clientX - touches[1].clientX;
    var dy = touches[0].clientY - touches[1].clientY;
    return Math.sqrt(dx * dx + dy * dy);
}

function getTouchMidpoint(touches) {
    var midClientX = (touches[0].clientX + touches[1].clientX) / 2;
    var midClientY = (touches[0].clientY + touches[1].clientY) / 2;
    return getCropPos({ clientX: midClientX, clientY: midClientY });
}

function canvasToImagePos(pos) {
    if (!cropImg) return { x: 0, y: 0 };
    var drawScale = cropView.baseScale * cropView.zoom;
    if (!drawScale) return { x: 0, y: 0 };
    return {
        x: clamp((pos.x - cropView.panX) / drawScale, 0, cropImg.width),
        y: clamp((pos.y - cropView.panY) / drawScale, 0, cropImg.height)
    };
}

function imageToCanvasPos(pos) {
    var drawScale = cropView.baseScale * cropView.zoom;
    return {
        x: pos.x * drawScale + cropView.panX,
        y: pos.y * drawScale + cropView.panY
    };
}

function getSelectionCanvasRect(sel) {
    if (!sel) return null;
    var p1 = imageToCanvasPos({ x: sel.x, y: sel.y });
    var p2 = imageToCanvasPos({ x: sel.x + sel.w, y: sel.y + sel.h });
    var left = Math.min(p1.x, p2.x);
    var top = Math.min(p1.y, p2.y);
    return {
        x: left,
        y: top,
        w: Math.abs(p2.x - p1.x),
        h: Math.abs(p2.y - p1.y)
    };
}

function beginPinch(e) {
    if (!cropImg || !e.touches || e.touches.length < 2) return;
    if (cropInteraction.active) {
        endCrop();
    }
    hideCropMagnifier();
    var distance = getTouchDistance(e.touches);
    if (!distance) return;
    var midpoint = getTouchMidpoint(e.touches);
    var imagePoint = canvasToImagePos(midpoint);

    pinchState.active = true;
    pinchState.startDistance = distance;
    pinchState.startZoom = cropView.zoom;
    pinchState.startMidX = midpoint.x;
    pinchState.startMidY = midpoint.y;
    pinchState.startImgX = imagePoint.x;
    pinchState.startImgY = imagePoint.y;
}

function movePinch(e) {
    if (!pinchState.active || !cropImg || !e.touches || e.touches.length < 2) return;
    var distance = getTouchDistance(e.touches);
    if (!distance || !pinchState.startDistance) return;
    var midpoint = getTouchMidpoint(e.touches);
    var zoomFactor = distance / pinchState.startDistance;

    cropView.zoom = clamp(pinchState.startZoom * zoomFactor, cropView.minZoom, cropView.maxZoom);
    var drawScale = cropView.baseScale * cropView.zoom;
    cropView.panX = midpoint.x - pinchState.startImgX * drawScale;
    cropView.panY = midpoint.y - pinchState.startImgY * drawScale;
    clampCropViewPan();
    renderCropCanvas();
}

function endPinch() {
    pinchState.active = false;
}

function hideCropMagnifier() {
    if (!cropMagnifier) return;
    cropMagnifier.classList.remove('visible');
}

function setCropMagnifierPosition(pos) {
    if (!cropMagnifier) return;
    var placeLeft = pos.x > cropCanvas.width * 0.58;
    var placeBottom = pos.y < cropCanvas.height * 0.42;
    cropMagnifier.style.left = placeLeft ? '8px' : '';
    cropMagnifier.style.right = placeLeft ? '' : '8px';
    cropMagnifier.style.bottom = placeBottom ? '8px' : '';
    cropMagnifier.style.top = placeBottom ? '' : '8px';
}

function renderCropMagnifier(pos) {
    if (!isMobile || !cropImg || !cropMagnifierCanvas || !cropMagnifierCtx) return;
    var imgPos = canvasToImagePos(pos);

    var lensW = cropMagnifierCanvas.width;
    var lensH = cropMagnifierCanvas.height;
    var srcW = lensW / CROP_MAGNIFIER_ZOOM;
    var srcH = lensH / CROP_MAGNIFIER_ZOOM;
    var centerX = imgPos.x;
    var centerY = imgPos.y;
    var srcX = clamp(centerX - srcW / 2, 0, Math.max(0, cropImg.width - srcW));
    var srcY = clamp(centerY - srcH / 2, 0, Math.max(0, cropImg.height - srcH));

    cropMagnifierCtx.clearRect(0, 0, lensW, lensH);
    cropMagnifierCtx.drawImage(cropImg, srcX, srcY, srcW, srcH, 0, 0, lensW, lensH);

    cropMagnifierCtx.strokeStyle = 'rgba(194,58,46,0.9)';
    cropMagnifierCtx.lineWidth = 1;
    cropMagnifierCtx.beginPath();
    cropMagnifierCtx.moveTo(lensW / 2, 0);
    cropMagnifierCtx.lineTo(lensW / 2, lensH);
    cropMagnifierCtx.moveTo(0, lensH / 2);
    cropMagnifierCtx.lineTo(lensW, lensH / 2);
    cropMagnifierCtx.stroke();

    cropMagnifierCtx.strokeStyle = 'rgba(255,255,255,0.85)';
    cropMagnifierCtx.strokeRect(1, 1, lensW - 2, lensH - 2);
}

function showCropMagnifier(pos) {
    if (!isMobile || !cropMagnifier) return;
    setCropMagnifierPosition(pos);
    renderCropMagnifier(pos);
    cropMagnifier.classList.add('visible');
}

function updateCropMagnifier(pos) {
    if (!isMobile || !cropMagnifier || !cropMagnifier.classList.contains('visible')) return;
    setCropMagnifierPosition(pos);
    renderCropMagnifier(pos);
}

function getCropPos(e) {
    var rect = cropCanvas.getBoundingClientRect();
    var clientX = e.clientX;
    var clientY = e.clientY;
    if (typeof clientX !== 'number' || typeof clientY !== 'number') {
        return { x: 0, y: 0 };
    }
    var scaleX = rect.width ? (cropCanvas.width / rect.width) : 1;
    var scaleY = rect.height ? (cropCanvas.height / rect.height) : 1;
    return {
        x: clamp((clientX - rect.left) * scaleX, 0, cropCanvas.width),
        y: clamp((clientY - rect.top) * scaleY, 0, cropCanvas.height)
    };
}

function isSelectionValid(sel) {
    return !!sel && sel.w >= CROP_MIN_SIZE && sel.h >= CROP_MIN_SIZE;
}

function isPointInSelection(pos, sel) {
    var rect = getSelectionCanvasRect(sel);
    if (!rect) return false;
    return pos.x >= rect.x && pos.x <= rect.x + rect.w && pos.y >= rect.y && pos.y <= rect.y + rect.h;
}

function getResizeHandle(pos, sel) {
    var rect = getSelectionCanvasRect(sel);
    if (!rect) return null;
    var hitSize = isMobile ? 24 : 14;
    var handles = {
        nw: { x: rect.x, y: rect.y },
        ne: { x: rect.x + rect.w, y: rect.y },
        sw: { x: rect.x, y: rect.y + rect.h },
        se: { x: rect.x + rect.w, y: rect.y + rect.h }
    };
    for (var key in handles) {
        if (!handles.hasOwnProperty(key)) continue;
        var handle = handles[key];
        if (Math.abs(pos.x - handle.x) <= hitSize && Math.abs(pos.y - handle.y) <= hitSize) {
            return key;
        }
    }
    return null;
}

function renderCropCanvas() {
    if (!cropImg) return;
    var ctx = cropCanvas.getContext('2d');
    ctx.clearRect(0, 0, cropCanvas.width, cropCanvas.height);
    clampCropViewPan();
    var drawScale = cropView.baseScale * cropView.zoom;
    var drawW = cropImg.width * drawScale;
    var drawH = cropImg.height * drawScale;
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = 'high';
    ctx.drawImage(cropImg, cropView.panX, cropView.panY, drawW, drawH);

    if (!cropSelection || cropSelection.w <= 0 || cropSelection.h <= 0) return;

    var rect = getSelectionCanvasRect(cropSelection);
    if (!rect) return;
    var rx = rect.x;
    var ry = rect.y;
    var rw = rect.w;
    var rh = rect.h;
    var x1 = clamp(rx, 0, cropCanvas.width);
    var y1 = clamp(ry, 0, cropCanvas.height);
    var x2 = clamp(rx + rw, 0, cropCanvas.width);
    var y2 = clamp(ry + rh, 0, cropCanvas.height);

    // Draw overlay outside selection
    ctx.fillStyle = 'rgba(0,0,0,0.32)';
    ctx.fillRect(0, 0, cropCanvas.width, y1);
    ctx.fillRect(0, y2, cropCanvas.width, cropCanvas.height - y2);
    ctx.fillRect(0, y1, x1, y2 - y1);
    ctx.fillRect(x2, y1, cropCanvas.width - x2, y2 - y1);

    // Draw selection border
    ctx.strokeStyle = '#c23a2e'; ctx.lineWidth = 2; ctx.setLineDash([6, 4]);
    ctx.strokeRect(rx, ry, rw, rh);
    ctx.setLineDash([]);

    // Draw corner handles (for mobile fine-tuning)
    var handleRadius = isMobile ? CROP_HANDLE_RADIUS + 1 : CROP_HANDLE_RADIUS;
    var points = [
        { x: rx, y: ry },
        { x: rx + rw, y: ry },
        { x: rx, y: ry + rh },
        { x: rx + rw, y: ry + rh }
    ];
    ctx.fillStyle = '#fff';
    ctx.strokeStyle = '#c23a2e';
    ctx.lineWidth = 2;
    points.forEach(function(point) {
        ctx.beginPath();
        ctx.arc(point.x, point.y, handleRadius, 0, Math.PI * 2);
        ctx.fill();
        ctx.stroke();
    });
}

function startCrop(e) {
    if (!cropImg || pinchState.active) return;

    var pos = getCropPos(e);
    var imgPos = canvasToImagePos(pos);
    showCropMagnifier(pos);
    cropInteraction.active = true;
    cropInteraction.startX = imgPos.x;
    cropInteraction.startY = imgPos.y;
    cropInteraction.origin = cloneSelection(cropSelection);

    if (isSelectionValid(cropSelection)) {
        var handle = getResizeHandle(pos, cropSelection);
        if (handle) {
            cropInteraction.mode = 'resize';
            cropInteraction.handle = handle;
            return;
        }
        if (isPointInSelection(pos, cropSelection)) {
            cropInteraction.mode = 'move';
            cropInteraction.handle = null;
            cropInteraction.offsetX = imgPos.x - cropSelection.x;
            cropInteraction.offsetY = imgPos.y - cropSelection.y;
            return;
        }
    }

    cropInteraction.mode = 'draw';
    cropInteraction.handle = null;
    cropSelection = { x: imgPos.x, y: imgPos.y, w: 0, h: 0 };
    croppedBlob = null;
    document.getElementById('cropSubmitBtn').disabled = true;
    renderCropCanvas();
}

function moveCrop(e) {
    if (!cropInteraction.active || !cropImg || pinchState.active) return;

    var pos = getCropPos(e);
    var imgPos = canvasToImagePos(pos);
    updateCropMagnifier(pos);
    if (cropInteraction.mode === 'draw') {
        var x = Math.min(cropInteraction.startX, imgPos.x);
        var y = Math.min(cropInteraction.startY, imgPos.y);
        cropSelection = {
            x: x,
            y: y,
            w: Math.abs(imgPos.x - cropInteraction.startX),
            h: Math.abs(imgPos.y - cropInteraction.startY)
        };
    } else if (cropInteraction.mode === 'move' && cropSelection) {
        cropSelection.x = clamp(imgPos.x - cropInteraction.offsetX, 0, cropImg.width - cropSelection.w);
        cropSelection.y = clamp(imgPos.y - cropInteraction.offsetY, 0, cropImg.height - cropSelection.h);
    } else if (cropInteraction.mode === 'resize' && cropInteraction.origin) {
        var origin = cropInteraction.origin;
        var x1 = origin.x;
        var y1 = origin.y;
        var x2 = origin.x + origin.w;
        var y2 = origin.y + origin.h;

        if (cropInteraction.handle === 'nw') {
            x1 = clamp(imgPos.x, 0, x2 - CROP_MIN_SIZE);
            y1 = clamp(imgPos.y, 0, y2 - CROP_MIN_SIZE);
        } else if (cropInteraction.handle === 'ne') {
            x2 = clamp(imgPos.x, x1 + CROP_MIN_SIZE, cropImg.width);
            y1 = clamp(imgPos.y, 0, y2 - CROP_MIN_SIZE);
        } else if (cropInteraction.handle === 'sw') {
            x1 = clamp(imgPos.x, 0, x2 - CROP_MIN_SIZE);
            y2 = clamp(imgPos.y, y1 + CROP_MIN_SIZE, cropImg.height);
        } else if (cropInteraction.handle === 'se') {
            x2 = clamp(imgPos.x, x1 + CROP_MIN_SIZE, cropImg.width);
            y2 = clamp(imgPos.y, y1 + CROP_MIN_SIZE, cropImg.height);
        }

        cropSelection = {
            x: x1,
            y: y1,
            w: x2 - x1,
            h: y2 - y1
        };
    }

    renderCropCanvas();
}

function buildCroppedBlobFromSelection() {
    if (!cropImg || !isSelectionValid(cropSelection)) {
        croppedBlob = null;
        document.getElementById('cropSubmitBtn').disabled = true;
        return;
    }

    var rx = clamp(cropSelection.x, 0, cropImg.width - 1);
    var ry = clamp(cropSelection.y, 0, cropImg.height - 1);
    var rw = Math.min(cropSelection.w, cropImg.width - rx);
    var rh = Math.min(cropSelection.h, cropImg.height - ry);

    var targetW = Math.max(1, Math.round(rw));
    var targetH = Math.max(1, Math.round(rh));
    var c2 = document.createElement('canvas');
    c2.width = targetW;
    c2.height = targetH;
    c2.getContext('2d').drawImage(cropImg, rx, ry, rw, rh, 0, 0, targetW, targetH);
    c2.toBlob(function(blob) {
        croppedBlob = blob;
        document.getElementById('cropSubmitBtn').disabled = !blob;
    }, 'image/jpeg', 0.9);
}

function endCrop() {
    if (!cropInteraction.active || !cropImg) return;

    hideCropMagnifier();
    cropInteraction.active = false;
    cropInteraction.mode = null;
    cropInteraction.handle = null;
    cropInteraction.origin = null;

    if (!isSelectionValid(cropSelection)) {
        cropSelection = null;
        croppedBlob = null;
        document.getElementById('cropSubmitBtn').disabled = true;
        renderCropCanvas();
        return;
    }

    renderCropCanvas();
    buildCroppedBlobFromSelection();
}

function resetCrop() {
    croppedBlob = null;
    cropSelection = null;
    hideCropMagnifier();
    endPinch();
    cropView.zoom = 1;
    cropView.panX = 0;
    cropView.panY = 0;
    clampCropViewPan();
    cropInteraction.active = false;
    cropInteraction.mode = null;
    cropInteraction.handle = null;
    cropInteraction.origin = null;
    document.getElementById('cropSubmitBtn').disabled = true;
    if (cropImg) {
        renderCropCanvas();
    }
}

function submitCroppedChar() {
    if (!croppedBlob) return;
    singleSelectedFile = new File([croppedBlob], 'cropped.jpg', { type: 'image/jpeg' });
    singlePreviewDataUrl = URL.createObjectURL(croppedBlob);
    submitSingleAnalysis();
}

// ==================== Image Compression ====================
function compressImage(file, maxSize, quality, options) {
    return new Promise(async (resolve, reject) => {
        try {
            options = options || {};
            var keepOriginalThresholdMB = typeof options.keepOriginalThresholdMB === 'number' ? options.keepOriginalThresholdMB : 8;
            var keepOriginalThresholdBytes = keepOriginalThresholdMB * 1024 * 1024;
            if (file.size <= keepOriginalThresholdBytes) {
                resolve(file);
                return;
            }

            let bitmap;
            try {
                if (typeof createImageBitmap === 'function') { bitmap = await createImageBitmap(file); }
                else { throw new Error('not supported'); }
            } catch (e) {
                bitmap = await new Promise((res, rej) => {
                    var reader = new FileReader();
                    reader.onload = function(ev) { var img = new Image(); img.onload = function() { res(img); }; img.onerror = rej; img.src = ev.target.result; };
                    reader.onerror = rej; reader.readAsDataURL(file);
                });
            }
            var width = bitmap.width, height = bitmap.height;
            var maxDim = Math.max(width, height);
            if (maxDim > maxSize) { var ratio = maxSize / maxDim; width = Math.round(width * ratio); height = Math.round(height * ratio); }
            var canvas = document.createElement('canvas'); canvas.width = width; canvas.height = height;
            var ctx = canvas.getContext('2d'); ctx.fillStyle = '#FFFFFF'; ctx.fillRect(0, 0, width, height);
            ctx.drawImage(bitmap, 0, 0, width, height);
            canvas.toBlob(function(blob) {
                if (!blob) {
                    reject(new Error('Canvas 压缩失败'));
                    return;
                }
                if (blob.size >= file.size * 0.97) {
                    resolve(file);
                    return;
                }
                resolve(new File([blob], file.name.replace(/\.[^/.]+$/, '') + '.jpg', { type: 'image/jpeg' }));
            }, 'image/jpeg', quality);
        } catch (err) { reject(err); }
    });
}

// ==================== Loading Effects ====================
var loadingTimerInterval = null, loadingStepInterval = null, tipInterval = null, loadingStartTime = 0;
var calligraphyTips = [
    '永字八法：「永」字包含了点、横、竖、撇、捺、钩、折、提八种基本笔画，是学习书法的入门之字。',
    '执笔要领：指实掌虚，腕平掌竖。五指自然执笔，掌心要空，像握着一个鸡蛋。',
    '颜真卿的《祭侄文稿》被称为"天下第二行书"，全篇情感激越，笔墨纵横。',
    '楷书四大家：欧阳询（欧体）、颜真卿（颜体）、柳公权（柳体）、赵孟頫（赵体）。',
    '写字要"逆入平出"：起笔时先逆锋入纸，再转为中锋行笔，笔画才饱满有力。',
    '米字格的作用：中心十字线帮助定位重心，对角线帮助把握笔画的倾斜角度。',
    '书法讲究"计白当黑"：不仅要看笔画，还要看留白，空间分布均匀才好看。'
];
var currentTip = 0, currentStep = 0;

function startLoadingEffects() {
    loadingStartTime = Date.now(); currentStep = 0;
    currentTip = Math.floor(Math.random() * calligraphyTips.length);
    var pdu = previewDataUrl || singlePreviewDataUrl;
    if (pdu) document.getElementById('loadingPreviewImg').src = pdu;
    var f = selectedFile || singleSelectedFile;
    if (f) {
        document.getElementById('loadingFileName').textContent = f.name;
        document.getElementById('loadingFileSize').textContent = (f.size / 1024).toFixed(1) + ' KB';
    }
    for (var i = 0; i < 4; i++) { document.getElementById('step' + i).className = 'step' + (i === 0 ? ' active' : ''); }
    renderTip();
    loadingTimerInterval = setInterval(function() { document.getElementById('loadingTimer').textContent = ((Date.now() - loadingStartTime) / 1000).toFixed(1) + 's'; }, 100);
    var stepTimes = [3000, 5000, 12000];
    loadingStepInterval = setInterval(function() {
        var elapsed = Date.now() - loadingStartTime;
        if (currentStep < 3 && elapsed > stepTimes[currentStep]) {
            document.getElementById('step' + currentStep).className = 'step done'; currentStep++;
            document.getElementById('step' + currentStep).className = 'step active';
        }
    }, 500);
    tipInterval = setInterval(function() { currentTip = (currentTip + 1) % calligraphyTips.length; renderTip(); }, 6000);
}

function renderTip() {
    var content = document.getElementById('tipContent'); content.style.opacity = '0';
    setTimeout(function() { content.textContent = calligraphyTips[currentTip]; content.style.opacity = '1'; }, 300);
    var dotsHtml = ''; for (var i = 0; i < calligraphyTips.length; i++) { dotsHtml += '<div class="tip-dot' + (i === currentTip ? ' active' : '') + '"></div>'; }
    document.getElementById('tipDots').innerHTML = dotsHtml;
}

function stopLoadingEffects() {
    if (loadingTimerInterval) { clearInterval(loadingTimerInterval); loadingTimerInterval = null; }
    if (loadingStepInterval) { clearInterval(loadingStepInterval); loadingStepInterval = null; }
    if (tipInterval) { clearInterval(tipInterval); tipInterval = null; }
    for (var i = 0; i < 4; i++) { document.getElementById('step' + i).className = 'step done'; }
}

// ==================== SSE: Whole Page Submit ====================
async function submitAnalysis() {
    if (!selectedFile) return;
    document.getElementById('analyzeBtn').disabled = true;
    uploadCard.style.display = 'none';
    document.getElementById('templateSection').style.display = 'none';
    loadingSection.classList.add('visible');
    document.getElementById('loadingTitle').textContent = '墨迹识别中';
    document.getElementById('loadingSubtitle').textContent = 'AI 正在细察每一笔一画';
    startLoadingEffects();
    setWechatTitle('AI批改中...');
    streamedText = ''; aiOutputStarted = false;

    try {
        showThinkingText('正在检查图片尺寸...');
        var compressedFile = await compressImage(selectedFile, 2048, 0.88, { keepOriginalThresholdMB: 8 });
        var compressedWhole = compressedFile !== selectedFile;
        document.getElementById('loadingFileSize').textContent = (compressedFile.size / 1024).toFixed(1) + ' KB' + (compressedWhole ? ' (已优化)' : ' (原图)');
        showThinkingText(compressedWhole ? '已优化图片体积，准备上传...' : '保持原图上传中...');

        var formData = new FormData();
        formData.append('file', compressedFile);
        if (selectedTemplateId) formData.append('templateId', selectedTemplateId);

        var response = await fetch('/api/homework/analyze-stream', { method: 'POST', body: formData });
        if (!response.ok) throw new Error('服务器返回错误: ' + response.status);

        var reader = response.body.getReader();
        var decoder = new TextDecoder('utf-8');
        var buffer = '', finalResult = null, currentEventName = null, currentEventData = '';

        function processLine(line) {
            if (line.startsWith('event:')) { currentEventName = line.substring(6).trim(); }
            else if (line.startsWith('data:')) { currentEventData += line.substring(5); }
            else if (line === '' && currentEventName) {
                handleSseEvent(currentEventName, currentEventData);
                if (currentEventName === 'result') { try { finalResult = JSON.parse(currentEventData); } catch(e) {} }
                currentEventName = null; currentEventData = '';
            }
        }

        while (true) {
            var readResult = await reader.read();
            if (readResult.done) break;
            buffer += decoder.decode(readResult.value, { stream: true });
            var lines = buffer.split('\n'); buffer = lines.pop() || '';
            for (var i = 0; i < lines.length; i++) processLine(lines[i]);
        }
        if (buffer.length > 0) { buffer.split('\n').forEach(processLine); if (currentEventName && currentEventData) processLine(''); }

        stopLoadingEffects();
        await new Promise(function(r) { setTimeout(r, 400); });
        loadingSection.classList.remove('visible');

        if (finalResult) {
            renderResults(finalResult);
            resultsSection.classList.add('visible');
            setWechatTitle('批改结果 - AI书法批改助手');
        } else { alert('批改完成但未收到结构化结果，请重试'); resetPage(); }
    } catch (err) { stopLoadingEffects(); loadingSection.classList.remove('visible'); alert('请求失败: ' + err.message); resetPage(); }
}

// ==================== SSE: Single Char Submit ====================
async function submitSingleAnalysis() {
    if (!singleSelectedFile) return;
    document.getElementById('singleAnalyzeBtn').disabled = true;
    document.getElementById('singleUploadCard').style.display = 'none';
    loadingSection.classList.add('visible');
    document.getElementById('loadingTitle').textContent = '深度分析中';
    document.getElementById('loadingSubtitle').textContent = 'AI 正在对这个字进行多维度评估';
    startLoadingEffects();
    setWechatTitle('AI精批中...');
    streamedText = ''; aiOutputStarted = false;

    try {
        showThinkingText('正在检查图片尺寸...');
        var compressedFile = await compressImage(singleSelectedFile, 1600, 0.9, { keepOriginalThresholdMB: 6 });
        var compressedSingle = compressedFile !== singleSelectedFile;
        document.getElementById('loadingFileSize').textContent = (compressedFile.size / 1024).toFixed(1) + ' KB' + (compressedSingle ? ' (已优化)' : ' (原图)');
        showThinkingText(compressedSingle ? '已优化图片体积，准备上传...' : '保持原图上传中...');

        var formData = new FormData();
        formData.append('file', compressedFile);

        var response = await fetch('/api/homework/analyze-single-stream', { method: 'POST', body: formData });
        if (!response.ok) throw new Error('服务器返回错误: ' + response.status);

        var reader = response.body.getReader();
        var decoder = new TextDecoder('utf-8');
        var buffer = '', finalResult = null, currentEventName = null, currentEventData = '';

        function processLine(line) {
            if (line.startsWith('event:')) { currentEventName = line.substring(6).trim(); }
            else if (line.startsWith('data:')) { currentEventData += line.substring(5); }
            else if (line === '' && currentEventName) {
                handleSseEvent(currentEventName, currentEventData);
                if (currentEventName === 'result') { try { finalResult = JSON.parse(currentEventData); } catch(e) {} }
                currentEventName = null; currentEventData = '';
            }
        }

        while (true) {
            var readResult = await reader.read();
            if (readResult.done) break;
            buffer += decoder.decode(readResult.value, { stream: true });
            var lines = buffer.split('\n'); buffer = lines.pop() || '';
            for (var i = 0; i < lines.length; i++) processLine(lines[i]);
        }
        if (buffer.length > 0) { buffer.split('\n').forEach(processLine); if (currentEventName && currentEventData) processLine(''); }

        stopLoadingEffects();
        await new Promise(function(r) { setTimeout(r, 400); });
        loadingSection.classList.remove('visible');

        if (finalResult) {
            renderSingleResult(finalResult);
            document.getElementById('singleResultSection').classList.add('visible');
            setWechatTitle('精批结果 - AI书法批改助手');
        } else { alert('精批完成但未收到结果，请重试'); resetPage(); }
    } catch (err) { stopLoadingEffects(); loadingSection.classList.remove('visible'); alert('请求失败: ' + err.message); resetPage(); }
}

// ==================== SSE Event Handler (Shared) ====================
function handleSseEvent(eventName, data) {
    if (eventName === 'start') {
        aiOutputStarted = false;
        document.getElementById('aiStreamSection').classList.add('visible');
        showThinkingText('正在连接 AI 模型...');
    } else if (eventName === 'thinking') {
        if (!aiOutputStarted) {
            showThinkingText(data);
            if (currentStep < 1) { document.getElementById('step0').className = 'step done'; currentStep = 1; document.getElementById('step1').className = 'step active'; }
        }
    } else if (eventName === 'token') {
        if (!aiOutputStarted) {
            aiOutputStarted = true;
            for (var s = 0; s <= 1; s++) document.getElementById('step' + s).className = 'step done';
            currentStep = 2; document.getElementById('step2').className = 'step active';
            document.querySelector('.ai-stream-header span:last-child').textContent = 'AI 输出中';
        }
        streamedText += data;
        showStreamingText(streamedText);
    } else if (eventName === 'result') {
        showStreamingText(streamedText, true);
        for (var s = 0; s <= 2; s++) document.getElementById('step' + s).className = 'step done';
        document.getElementById('step3').className = 'step active';
    } else if (eventName === 'error') {
        showStreamingText(streamedText + '\n\n[错误] ' + data, true);
    }
}

function showThinkingText(message) {
    var box = document.getElementById('aiStreamBox');
    box.innerHTML = '<span style="color:var(--indigo-light);font-style:italic;">' + message.replace(/&/g,'&amp;').replace(/</g,'&lt;') + '</span><span class="cursor-blink"></span>';
    box.scrollTop = box.scrollHeight;
}

function showStreamingText(text, finished) {
    var box = document.getElementById('aiStreamBox');
    var formatted = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
        .replace(/【(.*?)】/g, '<span class="highlight-title">【$1】</span>')
        .replace(/(结构|笔画|综合|重心|间架)[：:]\s*(\d+)\s*分/g, '<span class="score-hl">$1：$2 分</span>')
        .replace(/建议[：:]/g, '<span class="suggestion-hl">建议：</span>')
        .replace(/(\d+[.．、])\s*「(.+?)」/g, '<b>$1 「$2」</b>');
    box.innerHTML = finished ? formatted : formatted + '<span class="cursor-blink"></span>';
    box.scrollTop = box.scrollHeight;
}

// ==================== Render: Whole Page Results ====================
function renderResults(result) {
    document.getElementById('resultOriginalImg').src = previewDataUrl;
    var fileInfo = document.getElementById('fileInfoText');
    if (selectedFile) fileInfo.textContent = selectedFile.name + ' (' + (selectedFile.size / 1024).toFixed(1) + ' KB)';

    var problemCount = result.analyses ? result.analyses.length : 0;
    document.getElementById('metaInfo').innerHTML =
        '<span>任务 ' + result.taskId + '</span><span>识别 ' + result.totalCharacters + ' 字</span>' +
        '<span>重点点评 ' + problemCount + ' 字</span><span>耗时 ' + (result.processingTimeMs / 1000).toFixed(1) + 's</span>';

    var icons = ['&#9878;', '&#9635;', '&#9998;', '&#9733;'];
    var labels = ['综合评分', '结构评分', '笔画评分', '识别字数'];
    var values = [
        typeof result.avgOverallScore === 'number' ? result.avgOverallScore.toFixed(1) : result.avgOverallScore,
        typeof result.avgStructureScore === 'number' ? result.avgStructureScore.toFixed(1) : result.avgStructureScore,
        typeof result.avgStrokeScore === 'number' ? result.avgStrokeScore.toFixed(1) : result.avgStrokeScore,
        result.totalCharacters
    ];
    var barHtml = '';
    for (var i = 0; i < 4; i++) {
        barHtml += '<div class="stat-card"><span class="stat-icon">' + icons[i] + '</span><div class="score">' + values[i] + '</div><div class="label">' + labels[i] + '</div></div>';
    }
    document.getElementById('summaryBar').innerHTML = barHtml;
    document.querySelector('#summaryComment .scroll-text').textContent = result.summaryComment;

    var charGrid = document.getElementById('charGrid');
    charGrid.innerHTML = '';
    if (!result.analyses || result.analyses.length === 0) {
        charGrid.innerHTML = '<div style="text-align:center;color:var(--grey-text);padding:20px;">所有字都写得不错，暂无需要重点改进的字。</div>';
        return;
    }

    var hasGrid = result.gridRows > 0 && result.gridCols > 0;

    result.analyses.forEach(function(a, idx) {
        var scoreClass = a.overallScore >= 80 ? 'score-high' : a.overallScore >= 60 ? 'score-mid' : 'score-low';
        var charDisplay = a.recognizedChar || '第' + (idx + 1) + '字';
        var hasPos = a.row > 0 && a.column > 0;
        var posText = hasPos ? '第' + a.row + '行第' + a.column + '列' : '';
        var hasBackendImage = a.charImageBase64 && a.charImageBase64.length > 0;

        var leftHtml;
        if (hasBackendImage) {
            // 只有后端模板裁切成功才显示截图
            leftHtml = '<div class="char-crop-wrap" id="crop-' + idx + '"><div class="char-index">' + charDisplay + '</div></div>';
        } else {
            leftHtml = '<div class="char-index">' + charDisplay + '</div>';
        }

        var card = document.createElement('div');
        card.className = 'char-card';
        card.innerHTML =
            '<div class="char-header">' + leftHtml +
                '<div class="char-info"><div class="char-name">' + charDisplay +
                    '<span style="font-size:0.78rem;color:var(--grey-text);font-weight:400;margin-left:8px;">需要改进</span></div>' +
                    (posText ? '<div class="char-pos">' + posText + '</div>' : '') +
                '</div><div class="char-score ' + scoreClass + '">' + a.overallScore + '</div></div>' +
            '<div class="char-body">' +
                '<div class="detail-row"><span class="detail-label">结构</span><div class="brush-bar"><div class="brush-fill" style="width:' + a.structureScore + '%"></div></div><span class="score-num">' + a.structureScore + '</span></div>' +
                '<div class="detail-row"><span class="detail-label">笔画</span><div class="brush-bar"><div class="brush-fill" style="width:' + a.strokeScore + '%"></div></div><span class="score-num">' + a.strokeScore + '</span></div>' +
                '<div class="comment-section"><div class="comment-text">' + (a.structureComment || '') + (a.strokeComment ? ' ' + a.strokeComment : '') + '</div>' +
                    (a.suggestion ? '<div class="suggestion">' + a.suggestion + '</div>' : '') +
                '</div></div>';
        charGrid.appendChild(card);

        // Attach backend-cropped images only (no unreliable frontend fallback)
        (function(ci, cn, cp, bb) {
            var wrap = document.getElementById('crop-' + ci);
            if (!wrap || !bb) return;
            var src = 'data:image/png;base64,' + bb;
            wrap.innerHTML = '<img class="char-crop-img" src="' + src + '" alt="' + cn + '">';
            wrap.onclick = function() { openCharLightbox(src, cn, cp); };
        })(idx, charDisplay, posText, a.charImageBase64);
    });

    // 检查是否有任何截图成功
    var hasAnyImage = result.analyses.some(function(a) { return a.charImageBase64 && a.charImageBase64.length > 0; });
    if (!hasAnyImage && result.analyses.length > 0) {
        var tipDiv = document.createElement('div');
        tipDiv.style.cssText = 'text-align:center;color:var(--grey-text);font-size:0.82rem;padding:14px 16px;margin-top:12px;background:linear-gradient(135deg,#f8f1e4,#f5ecdb);border:1px solid rgba(196,160,85,0.15);border-radius:8px;line-height:1.6;';
        tipDiv.innerHTML = '&#128161; <b>提示</b>：想要看到每个字的精确截图？请在上传时<b>选择字帖模板</b>，或使用<b>「单字精批」</b>模式对单个字进行深度分析。';
        charGrid.parentNode.appendChild(tipDiv);
    }
}

// ==================== Render: Single Char Result ====================
function renderSingleResult(result) {
    // Char display
    var displayHtml = '';
    if (singlePreviewDataUrl) {
        displayHtml += '<img src="' + singlePreviewDataUrl + '" alt="' + (result.recognizedChar || '') + '">';
    }
    displayHtml += '<div class="char-label">' + (result.recognizedChar || '?') + '</div>';
    document.getElementById('singleCharDisplay').innerHTML = displayHtml;

    // Scores grid
    var scores = [
        { label: '结构', val: result.structureScore },
        { label: '笔画', val: result.strokeScore },
        { label: '重心', val: result.balanceScore },
        { label: '间架', val: result.spacingScore },
        { label: '综合', val: result.overallScore }
    ];
    var scHtml = '';
    scores.forEach(function(s) {
        var cls = s.val >= 80 ? 'score-high' : s.val >= 60 ? 'score-mid' : 'score-low';
        scHtml += '<div class="single-score-item"><div class="s-val ' + cls + '">' + s.val + '</div><div class="s-label">' + s.label + '</div></div>';
    });
    document.getElementById('singleScoresGrid').innerHTML = scHtml;

    // Analysis blocks
    var blocks = [
        { icon: '&#9635;', title: '结构分析', content: result.structureDetail },
        { icon: '&#9998;', title: '笔画分析', content: result.strokeDetail },
        { icon: '&#9878;', title: '重心分析', content: result.balanceDetail },
        { icon: '&#9633;', title: '间架分析', content: result.spacingDetail },
        { icon: '&#9733;', title: '总评', content: result.overallComment }
    ];
    var abHtml = '';
    blocks.forEach(function(b) {
        if (b.content) {
            abHtml += '<div class="analysis-block"><div class="ab-title"><span>' + b.icon + '</span> ' + b.title + '</div><div class="ab-content">' + b.content + '</div></div>';
        }
    });
    document.getElementById('singleAnalysisBlocks').innerHTML = abHtml;

    // Suggestion
    if (result.suggestion) {
        document.getElementById('singleSuggestionContent').textContent = result.suggestion;
        document.getElementById('singleSuggestionBlock').style.display = 'block';
    } else {
        document.getElementById('singleSuggestionBlock').style.display = 'none';
    }
}

// ==================== Utilities ====================
function copyToClipboard(text) {
    if (navigator.clipboard && window.isSecureContext) return navigator.clipboard.writeText(text);
    var ta = document.createElement('textarea'); ta.value = text; ta.style.cssText = 'position:fixed;left:-9999px;top:0;opacity:0;';
    document.body.appendChild(ta); ta.focus(); ta.select();
    try { document.execCommand('copy'); } catch(e) {}
    document.body.removeChild(ta);
    return Promise.resolve();
}

function copyFullReport() {
    if (!streamedText) return;
    copyToClipboard(streamedText).then(function() {
        var btns = document.querySelectorAll('.btn-copy');
        btns.forEach(function(btn) { var o = btn.innerHTML; btn.innerHTML = '<span>&#10003;</span> 已复制'; setTimeout(function() { btn.innerHTML = o; }, 2000); });
    }).catch(function() { alert('复制失败，请长按文本手动复制'); });
}

function setWechatTitle(title) {
    document.title = title;
    if (isWechat) {
        var iframe = document.createElement('iframe'); iframe.style.display = 'none'; iframe.src = '/favicon.ico';
        iframe.onload = function() { setTimeout(function() { try { document.body.removeChild(iframe); } catch(e) {} }, 0); };
        document.body.appendChild(iframe);
    }
}

function openCharLightbox(imgSrc, charName, posText) {
    document.getElementById('charLightboxImg').src = imgSrc;
    var label = '<span class="lb-char">' + charName + '</span>';
    if (posText) label += '<span class="lb-pos">' + posText + '</span>';
    document.getElementById('charLightboxLabel').innerHTML = label;
    document.getElementById('charLightbox').classList.add('visible');
}

function closeCharLightbox(e) {
    if (e && e.target.classList.contains('char-lightbox-img')) return;
    document.getElementById('charLightbox').classList.remove('visible');
}

function resetPage() {
    stopLoadingEffects();
    setWechatTitle('AI书法批改助手');
    selectedFile = null; singleSelectedFile = null;
    previewDataUrl = null; singlePreviewDataUrl = null;
    streamedText = ''; aiOutputStarted = false;
    croppedBlob = null; cropImg = null; cropSelection = null;
    hideCropMagnifier();
    endPinch();
    cropView.zoom = 1;
    cropView.panX = 0;
    cropView.panY = 0;
    cropInteraction.active = false;
    cropInteraction.mode = null;
    cropInteraction.handle = null;
    cropInteraction.origin = null;
    // Reset file inputs
    ['fileInput','cameraInput','albumInput','singleFileInput','singleCameraInput','singleAlbumInput','cropPageInput'].forEach(function(id) {
        var el = document.getElementById(id); if (el) el.value = '';
    });
    // Reset visibility
    previewSection.classList.remove('visible');
    document.getElementById('singlePreviewSection').classList.remove('visible');
    document.getElementById('cropSection').classList.remove('visible');
    loadingSection.classList.remove('visible');
    resultsSection.classList.remove('visible');
    document.getElementById('singleResultSection').classList.remove('visible');
    // Show upload cards
    uploadCard.style.display = 'block';
    document.getElementById('singleUploadCard').style.display = 'block';
    document.getElementById('templateSection').style.display = 'block';
    document.getElementById('analyzeBtn').disabled = false;
    document.getElementById('singleAnalyzeBtn').disabled = false;
    // Restore upload areas
    if (isMobile) {
        uploadArea.style.display = 'none'; mobileUpload.style.display = 'block';
        document.getElementById('singleUploadArea').style.display = 'none';
        document.getElementById('singleMobileUpload').style.display = 'block';
    } else {
        uploadArea.style.display = 'block'; mobileUpload.style.display = 'none';
        document.getElementById('singleUploadArea').style.display = 'block';
        document.getElementById('singleMobileUpload').style.display = 'none';
    }
    // Reset AI stream
    document.getElementById('aiStreamSection').classList.remove('visible');
    document.getElementById('aiStreamBox').innerHTML = '<span class="cursor-blink"></span>';
    // Restore current mode panel visibility
    document.getElementById('wholePageMode').style.display = currentMode === 'whole' ? 'block' : 'none';
    document.getElementById('singleCharMode').style.display = currentMode === 'single' ? 'block' : 'none';
}

// 从其他页面返回时（含浏览器后退、bfcache 恢复），恢复为初始上传界面，避免空白
window.addEventListener('pageshow', function(ev) {
    if (ev.persisted) {
        resetPage();
    }
});
</script>
</body>
</html>
